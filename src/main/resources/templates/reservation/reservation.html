<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" th:href="@{/css/base/nav.css}">
    <link rel="stylesheet" th:href="@{/css/reservation/reservation.css}">
    <link rel="stylesheet" th:href="@{https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css}">
    <script th:src="@{https://cdn.jsdelivr.net/npm/flatpickr}"></script>
    <script th:src="@{https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js}"></script>
    <style>
        
    </style>
</head>
<body>
    <div class="background-container"></div>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <header>
        <nav>
            <!--ë„¤ë¹„ë°”-->
            <span onclick="location.href='/main'">WashPlan</span>
            <span style="color: #FFFF00;">ì˜ˆì•½</span>
            <span>FAQ</span>
            <span>íšŒì›ê°€ì…</span>
            <span>ë¡œê·¸ì¸</span>
        </nav>
    </header>

    <!-- íƒ­ ë²„íŠ¼ -->
    <button class="wash" id="washButton">ì„¸íƒê¸°</button>
    <button class="dry" id="dryButton">ê±´ì¡°ê¸°</button>

    <span class="imtDate">ğŸ“†</span>
    <span class="imtTime">â³</span>

    <!-- ì„¸íƒê¸° ì„¹ì…˜ -->
    <div class="washReserve" id="washReserve">
        <div class="reserveTime">
            <input id="washDatetimePicker" type="text" class="datetime-picker" placeholder="ì‹œê°„ ì„ íƒ">
        </div>
        <p id="washTimeRangeDisplay" class="time-range-display"></p>

        <span class="machine">ê¸°ê¸°</span>
        <span class="curent">í˜„í™©</span>
        <span class="option">ì˜µì…˜</span>
        <span class="price">ê°€ê²©</span>
        <span class="reserve">ì˜ˆì•½</span>
        <hr>

        <!-- ì„¸íƒê¸° ëª©ë¡ -->
        <div class="washing-machines-container">
            <div th:each="machine : ${washingMachines}" class="machine-row" th:data-machine="${machine.machineNo}">
                <img class="washimage" th:src="@{/images/reservation/wash.png}" alt="ì„¸íƒê¸°">
                <span th:class="'í˜¸' + ${machine.machineNo}">ì„¸íƒê¸° - <span th:text="${machine.machineNo}"></span>í˜¸</span>
                <div class="situation">
                    <span th:text="${machine.machineStatus}">ì‚¬ìš©ê°€ëŠ¥</span>
                </div>
                <div class="dropdown-container">
                    <select th:id="'wash-options-' + ${machine.machineNo}" class="dropdown">
                        <option value="í‘œì¤€ì„¸íƒ" data-price="5,000">í‘œì¤€ì„¸íƒ (30ë¶„)</option>
                        <option value="ì¹¨êµ¬ì„¸íƒ" data-price="6,000">ì¹¨êµ¬ì„¸íƒ (40ë¶„)</option>
                    </select>
                </div>
                <div th:id="'wash-selected-option-' + ${machine.machineNo}" class="result">
                    5,000ì›
                </div>
                <button th:id="'reserveButton-' + ${machine.machineNo}" 
                        class="reservebtn"
                        th:disabled="${machine.machineStatus != 'ì‚¬ìš©ê°€ëŠ¥'}">
                    ì˜ˆì•½í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- ê±´ì¡°ê¸° ì„¹ì…˜ -->
    <div class="dryReserve" id="dryReserve" style="display: none;">
        <div class="reserveTime">
            <input id="dryDatetimePicker" type="text" class="datetime-picker" placeholder="ì‹œê°„ ì„ íƒ">
        </div>
        <p id="dryTimeRangeDisplay" class="time-range-display"></p>

        <span class="machine">ê¸°ê¸°</span>
        <span class="curent">í˜„í™©</span>
        <span class="option">ì˜µì…˜</span>
        <span class="price">ê°€ê²©</span>
        <span class="reserve">ì˜ˆì•½</span>
        <hr>

        <!-- ê±´ì¡°ê¸° ëª©ë¡ -->
        <div class="drying-machines-container">
            <div th:each="machine : ${dryingMachines}" class="machine-row" th:data-machine="${machine.machineNo}">
                <img class="dryimage" th:src="@{/images/reservation/dry.png}" alt="ê±´ì¡°ê¸°">
                <span th:class="'í˜¸' + ${machine.machineNo}">ê±´ì¡°ê¸° - <span th:text="${machine.machineNo}"></span>í˜¸</span>
                <div class="situation">
                    <span th:text="${machine.machineStatus}">ì‚¬ìš©ê°€ëŠ¥</span>
                </div>
                <div class="dropdown-container">
                    <select th:id="'dry-options-' + ${machine.machineNo}" class="dropdown">
                        <option value="í‘œì¤€ê±´ì¡°" data-price="5,000">í‘œì¤€ê±´ì¡° (30ë¶„)</option>
                        <option value="ê°•ë ¥ê±´ì¡°" data-price="6,000">ê°•ë ¥ê±´ì¡° (40ë¶„)</option>
                    </select>
                </div>
                <div th:id="'dry-selected-option-' + ${machine.machineNo}" class="result">
                    5,000ì›
                </div>
                <button th:id="'reserveButton-' + ${machine.machineNo}" 
                        class="reservebtn"
                        th:disabled="${machine.machineStatus != 'ì‚¬ìš©ê°€ëŠ¥'}">
                    ì˜ˆì•½í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- ê° ê¸°ê¸°ë³„ ëª¨ë‹¬ ë™ì  ìƒì„± -->
    <div th:each="machine : ${allMachines}" 
         th:id="'modal-' + ${machine.machineNo}" 
         class="modal">
        <!-- ì˜ˆì•½ í™•ì¸ ëª¨ë‹¬ -->
        <div th:id="'modal-content-' + ${machine.machineNo}" class="modal-content">
            <p class="modal-text">
                "ì˜ˆì•½ëœ ì‹œê°„ìœ¼ë¡œë¶€í„° 10ë¶„ ì´ë‚´ì— ì´ìš©ì„ ì‹œì‘í•˜ì§€ ì•Šì„ ê²½ìš°, <br>ì˜ˆì•½ì´ ìë™ ì·¨ì†Œë©ë‹ˆë‹¤.<br>
                ìë™ ì·¨ì†Œê°€ 3íšŒ ë°œìƒí•  ê²½ìš°, ê³„ì •ì´ ì¼ì‹œ ì •ì§€ë©ë‹ˆë‹¤."<br><br>
            </p>
            <span class="reserveText">ìœ„ ë‚´ìš©ì„ í™•ì¸í•˜ì‹œê³  
                <span th:id="'modalTimeDisplay-' + ${machine.machineNo}" class="modal-time"></span> 
                ì˜ˆì•½ì„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
            </span>
            <button th:id="'cancelButton-' + ${machine.machineNo}" class="cancel">ì·¨ì†Œ</button>
            <button th:id="'confirmButton-' + ${machine.machineNo}" class="confirm">í™•ì¸</button>
        </div>

        <!-- QR ì½”ë“œ ëª¨ë‹¬ -->
        <div th:id="'modal-content2-' + ${machine.machineNo}" class="modal-content2">
            <span class="reserveConfirm">ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</span>
            <span class="qrText">QRì½”ë“œëŠ” ë§ˆì´í˜ì´ì§€ì—ì„œ í™•ì¸í•˜ì„¸ìš”</span>
            <img th:id="'qrCode-' + ${machine.machineNo}" class="qr-code" src="" alt="QR Code">
            <button th:id="'confirmButton2-' + ${machine.machineNo}" class="confirm2">í™•ì¸</button>
        </div>
    </div>

<footer>
    <span>ğŸ“031-123-4567ã…£âœ‰ï¸contact@washplan.com</span>
    <span>ğŸš©ê²½ê¸° í•˜ë‚¨ì‹œ ë¯¸ì‚¬ê°•ë³€ë™ë¡œ 85 íìŠ¤í…Œì´íŠ¸ ì—ì½” 3ì¸µ</span>
    <span>â“’ 2024 PPal-Ajoã…£All rights reserved.Designed for your convenience.</span>
</footer>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // 1. ê¸°ë³¸ ìš”ì†Œ ì´ˆê¸°í™”
    const washButton = document.getElementById("washButton");
    const dryButton = document.getElementById("dryButton");
    const washReserve = document.getElementById("washReserve");
    const dryReserve = document.getElementById("dryReserve");
    const washTimeRangeDisplay = document.getElementById("washTimeRangeDisplay");
    const dryTimeRangeDisplay = document.getElementById("dryTimeRangeDisplay");

    // 2. ì‹œê°„ ê´€ë ¨ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    function getDefaultStartTime() {
        const now = new Date();
        now.setMinutes(Math.ceil(now.getMinutes() / 10) * 10, 0, 0);
        now.setHours(now.getHours() + 1);
        return now;
    }

    function calculateAndFormatEndTime(startTime) {
        const endTime = new Date(startTime);
        endTime.setHours(endTime.getHours() + 1);
        return formatTime(endTime);
    }

    function formatTime(date) {
        return `${String(date.getHours()).padStart(2, "0")}:${String(date.getMinutes()).padStart(2, "0")}`;
    }

    // 3. Flatpickr ì´ˆê¸°í™” í•¨ìˆ˜
    async function initializeFlatpickr(selector, displayElement) {
        const defaultStartTime = getDefaultStartTime();
        let minTime = formatTime(defaultStartTime);
        const defaultEndTime = calculateAndFormatEndTime(defaultStartTime);

        displayElement.textContent = `${formatTime(defaultStartTime)} ~ ${defaultEndTime}`;

        return flatpickr(selector, {
            enableTime: true,
            dateFormat: "Y-m-d ã…£ H:i",
            time_24hr: true,
            minuteIncrement: 10,
            locale: "ko",
            defaultDate: defaultStartTime,
            minDate: "today",
            maxDate: new Date().fp_incr(7),
            minTime: minTime,
            onChange: async function(selectedDates, dateStr, instance) {
                if (selectedDates.length > 0) {
                    // ë§Œë£Œëœ ì˜ˆì•½ ì²˜ë¦¬
                    await handleExpiredReservations();

                    const startTime = selectedDates[0];
                    const formattedStartTime = formatTime(startTime);
                    const endTime = calculateAndFormatEndTime(startTime);

                    displayElement.textContent = `${formattedStartTime} ~ ${endTime}`;

                    // ì‹œê°„ ë³€ê²½ ì‹œ í•´ë‹¹ íƒ€ì…ì˜ ëª¨ë“  ê¸°ê¸° ìƒíƒœ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                    const type = selector.includes('wash') ? 'wash' : 'dry';
                    const machines = document.querySelectorAll(`[data-machine^="${type === 'wash' ? '1' : '2'}"]`);
                    for (const machine of machines) {
                        await checkAndUpdateReservationStatus(machine.dataset.machine);
                    }

                    const today = new Date();
                    const isToday = startTime.toDateString() === today.toDateString();
                    
                    if (isToday) {
                        minTime = `${String(today.getHours() + 1).padStart(2, "0")}:${String(
                            Math.ceil(today.getMinutes() / 10) * 10
                        ).padStart(2, "0")}`;
                    } else {
                        minTime = "00:00";
                    }

                    instance.set("minTime", minTime);
                }
            }
        });
    }

    // 4. ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™” í•¨ìˆ˜
    function initializeDropdown(machineNo, type) {
        const dropdown = document.getElementById(`${type}-options-${machineNo}`);
        const resultDisplay = document.getElementById(`${type}-selected-option-${machineNo}`);

        dropdown.addEventListener("change", function() {
            const selectedPrice = this.options[this.selectedIndex].getAttribute("data-price");
            resultDisplay.textContent = `${selectedPrice}ì›`;
        });
    }

    // 5. ê¸°ê¸° ìƒíƒœ ì²´í¬ í•¨ìˆ˜
    async function checkMachineStatus(machineNo) {
        try {
            // ë¨¼ì € ë§Œë£Œëœ ì˜ˆì•½ë“¤ ì²˜ë¦¬
            await handleExpiredReservations();
            
            const response = await fetch(`/reservation/status/${machineNo}`);
            if (!response.ok) throw new Error("ê¸°ê¸° ìƒíƒœ í™•ì¸ ì‹¤íŒ¨");
            
            const status = await response.text();
            const situationElement = document.querySelector(`[data-machine="${machineNo}"] .situation span`);
            const reserveButton = document.getElementById(`reserveButton-${machineNo}`);

            if (status === "ê³ ì¥") {
                updateMachineStatus(status, situationElement, reserveButton);
                return;
            }

            checkAndUpdateReservationStatus(machineNo);
        } catch (error) {
            console.error("ê¸°ê¸° ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜:", error);
        }
    }

    // 6. ê¸°ê¸° ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateMachineStatus(status, situationElement, reserveButton) {
        const statusColors = {
            "ê³ ì¥": "#A500FF",
            "ì˜ˆì•½ì¤‘": "#FD3C3C",
            "ì‚¬ìš©ê°€ëŠ¥": "#0062FF"
        };

        situationElement.textContent = status;
        situationElement.style.color = statusColors[status];
        reserveButton.disabled = status !== "ì‚¬ìš©ê°€ëŠ¥";
        
        if (status !== "ì‚¬ìš©ê°€ëŠ¥") {
            reserveButton.classList.add("disabled-button");
        } else {
            reserveButton.classList.remove("disabled-button");
        }
    }

    // 7. ì˜ˆì•½ ìƒíƒœ í™•ì¸ í•¨ìˆ˜
    async function checkAndUpdateReservationStatus(machineNo) {
        const situationElement = document.querySelector(`[data-machine="${machineNo}"] .situation span`);
        const currentStatus = situationElement.textContent;
        
        // ì´ë¯¸ ê³ ì¥ ìƒíƒœì¸ ê²½ìš° ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ í•˜ì§€ ì•ŠìŒ
        if (currentStatus === "ê³ ì¥") {
            return;
        }

        const type = machineNo < 200 ? "wash" : "dry";
        const datePickerId = `${type}DatetimePicker`;
        const timeRangeId = `${type}TimeRangeDisplay`;

        const reservationData = {
            machineNo: machineNo,
            reserveDate: document.getElementById(datePickerId).value.split(" ")[0],
            startTime: document.getElementById(timeRangeId).textContent.split("~")[0].trim(),
            endTime: document.getElementById(timeRangeId).textContent.split("~")[1].trim()
        };

        try {
            const response = await fetch("/reservation/checkStatus", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(reservationData)
            });

            const data = await response.json();
            const reserveButton = document.getElementById(`reserveButton-${machineNo}`);

            // ê³ ì¥ ìƒíƒœê°€ ì•„ë‹ ë•Œë§Œ ìƒíƒœ ì—…ë°ì´íŠ¸
            if (currentStatus !== "ê³ ì¥") {
                updateMachineStatus(data.status, situationElement, reserveButton);
            }
        } catch (error) {
            console.error("ì˜ˆì•½ ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜:", error);
        }
    }

    // 8. ì˜ˆì•½ ì²˜ë¦¬ í•¨ìˆ˜
    async function handleReservation(machineNo) {
        const type = machineNo < 200 ? "wash" : "dry";
        const reservationData = {
            machineNo: machineNo,
            reserveDate: document.getElementById(`${type}DatetimePicker`).value.split(" ")[0],
            startTime: document.getElementById(`${type}TimeRangeDisplay`).textContent.split("~")[0].trim(),
            endTime: document.getElementById(`${type}TimeRangeDisplay`).textContent.split("~")[1].trim(),
            reserveOption: document.getElementById(`${type}-options-${machineNo}`).value,
            reservePrice: parseInt(document.getElementById(`${type}-selected-option-${machineNo}`).textContent.replace(/[^0-9]/g, ""), 10)
        };

        try {
            const response = await fetch("/reservation/save", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(reservationData)
            });

            const data = await response.json();
            if (data.qrCode) {
                // ì˜ˆì•½ ì„±ê³µ ì‹œ ì¦‰ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
                const situationElement = document.querySelector(`[data-machine="${machineNo}"] .situation span`);
                const reserveButton = document.getElementById(`reserveButton-${machineNo}`);
                updateMachineStatus("ì˜ˆì•½ì¤‘", situationElement, reserveButton);
                
                showQRCodeModal(machineNo, data.qrCode);
            } else {
                alert("ì˜ˆì•½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        } catch (error) {
            console.error("ì˜ˆì•½ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", error);
            alert("ì˜ˆì•½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // 9. ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
    function showReservationModal(machineNo) {
        const type = machineNo < 200 ? "wash" : "dry";
        const timeRangeDisplay = document.getElementById(`${type}TimeRangeDisplay`);
        const modalTimeDisplay = document.getElementById(`modalTimeDisplay-${machineNo}`);
        const modal = document.getElementById(`modal-${machineNo}`);
        
        // ì„ íƒëœ ì‹œê°„ ï¿½ï¿½ìœ„ë¥¼ ëª¨ë‹¬ì— í‘œì‹œ
        if (timeRangeDisplay && modalTimeDisplay) {
            modalTimeDisplay.textContent = timeRangeDisplay.textContent;
        }

        // ëª¨ë‹¬ í‘œì‹œ
        if (modal) {
            modal.style.display = "block";
            document.body.classList.add("no-scroll");
        }
    }

    function showQRCodeModal(machineNo, qrCode) {
        const modal = document.getElementById(`modal-${machineNo}`);
        const modal1 = document.getElementById(`modal-content-${machineNo}`);
        const modal2 = document.getElementById(`modal-content2-${machineNo}`);
        const qrImage = document.getElementById(`qrCode-${machineNo}`);

        modal1.style.display = "none";
        qrImage.src = "data:image/png;base64," + qrCode;
        qrImage.style.display = "block";
        modal2.style.display = "block";
    }

    // 10. ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    washButton.classList.add("active");
    initializeFlatpickr("#washDatetimePicker", washTimeRangeDisplay);
    initializeFlatpickr("#dryDatetimePicker", dryTimeRangeDisplay);

    // íƒ­ ì „í™˜ ì´ë²¤íŠ¸
    washButton.addEventListener("click", () => {
        washReserve.style.display = "block";
        dryReserve.style.display = "none";
        washButton.classList.add("active");
        dryButton.classList.remove("active");
    });

    dryButton.addEventListener("click", () => {
        washReserve.style.display = "none";
        dryReserve.style.display = "block";
        dryButton.classList.add("active");
        washButton.classList.remove("active");
    });

    // ë§Œë£Œëœ ì˜ˆì•½ ì²˜ë¦¬ í•¨ìˆ˜ ì¶”ê°€
    async function handleExpiredReservations() {
        try {
            const response = await fetch("/reservation/check-expired", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                }
            });
            
            if (!response.ok) {
                throw new Error("ë§Œë£Œëœ ì˜ˆì•½ ì²˜ë¦¬ ì‹¤íŒ¨");
            }
        } catch (error) {
            console.error("ë§Œë£Œëœ ì˜ˆì•½ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", error);
        }
    }

    // ê¸°ê¸° ëª©ë¡ì„ ë™ì ìœ¼ë¡œ ìƒì„±í•˜ëŠ” í•¨ìˆ˜ ì¶”ê°€
    async function loadMachines() {
        try {
            // ì„¸íƒê¸°ì™€ ê±´ì¡°ê¸° ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const washResponse = await fetch("/adminmachine/wash");
            const dryResponse = await fetch("/adminmachine/dry");
            
            if (!washResponse.ok || !dryResponse.ok) {
                throw new Error("ê¸°ê¸° ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }

            const washMachines = await washResponse.json();
            const dryMachines = await dryResponse.json();

            // ì„¸íƒê¸°ì™€ ê±´ì¡°ê¸° ì„¹ì…˜
            const washReserve = document.querySelector(".washReserve");
            const dryReserve = document.querySelector(".dryReserve");

            // ìƒˆë¡œìš´ ê¸°ê¸° ì¶”ê°€ ë° ì„¹ì…˜ ë†’ì´ ì¡°ì •
            washMachines.forEach(machine => {
                if (!document.querySelector(`[data-machine="${machine.machineNo}"]`)) {
                    const machineElement = createMachineElement(machine, "wash");
                    washReserve.appendChild(machineElement);
                }
            });

            dryMachines.forEach(machine => {
                if (!document.querySelector(`[data-machine="${machine.machineNo}"]`)) {
                    const machineElement = createMachineElement(machine, "dry");
                    dryReserve.appendChild(machineElement);
                }
            });

            // ì„¹ì…˜ ë†’ì´ ê³„ì‚° ë° ì¡°ì •
            const washHeight = 680 + (washMachines.length > 3 ? (washMachines.length - 3) * 170 : 0);
            const dryHeight = 680 + (dryMachines.length > 3 ? (dryMachines.length - 3) * 170 : 0);

            washReserve.style.height = `${washHeight}px`;
            dryReserve.style.height = `${dryHeight}px`;

            // í‘¸í„° ìœ„ì¹˜ ì¡°ì •
            const maxHeight = Math.max(washHeight, dryHeight);
            const footer = document.querySelector('footer');
            footer.style.top = `${maxHeight + 364}px`; // 364ëŠ” í‘¸í„°ê¹Œì§€ì˜ ê¸°ë³¸ ì—¬ë°±

            // ë°°ê²½ ì»¨í…Œì´ë„ˆ ë†’ì´ ì¡°ì •
            const background = document.querySelector('.background-container');
            background.style.height = `${maxHeight + 511}px`; // 511ì€ í‘¸í„° í¬í•¨ ì—¬ë°±

            // ìƒˆë¡œ ì¶”ê°€ëœ ê¸°ê¸°ë“¤ì— ëŒ€í•œ ì´ˆê¸°í™”
            initializeNewMachines();

        } catch (error) {
            console.error("ê¸°ê¸° ë¡œë”© ì¤‘ ì˜¤ë¥˜:", error);
        }
    }

    // ê°œë³„ ê¸°ê¸° ìš”ì†Œ ìƒì„± í•¨ìˆ˜
    function createMachineElement(machine, type) {
        const machineDiv = document.createElement('div');
        machineDiv.className = 'machine-row';
        machineDiv.dataset.machine = machine.machineNo;

        machineDiv.innerHTML = `
            <img class="${type}image" src="/images/reservation/${type}.png" alt="${type === 'wash' ? 'ì„¸íƒê¸°' : 'ê±´ì¡°ê¸°'}">
            <span class="í˜¸${machine.machineNo}">${type === 'wash' ? 'ì„¸íƒê¸°' : 'ê±´ì¡°ê¸°'} - ${machine.machineNo}í˜¸</span>
            <div class="situation">
                <span>${machine.machineStatus}</span>
            </div>
            <div class="dropdown-container">
                <select id="${type}-options-${machine.machineNo}" class="dropdown">
                    ${type === 'wash' ? `
                        <option value="í‘œì¤€ì„¸íƒ" data-price="5,000">í‘œì¤€ì„¸íƒ (30ë¶„)</option>
                        <option value="ì¹¨êµ¬ì„¸íƒ" data-price="6,000">ì¹¨êµ¬ì„¸íƒ (40ë¶„)</option>
                    ` : `
                        <option value="í‘œì¤€ê±´ì¡°" data-price="5,000">í‘œì¤€ê±´ì¡° (30ë¶„)</option>
                        <option value="ê°•ë ¥ê±´ì¡°" data-price="6,000">ê°•ë ¥ê±´ì¡° (40ë¶„)</option>
                    `}
                </select>
            </div>
            <div id="${type}-selected-option-${machine.machineNo}" class="result">
                5,000ì›
            </div>
            <button id="reserveButton-${machine.machineNo}" 
                    class="reservebtn"
                    ${machine.machineStatus !== 'ì‚¬ìš©ê°€ëŠ¥' ? 'disabled' : ''}>
                ì˜ˆì•½í•˜ê¸°
            </button>
        `;

        // ëª¨ë‹¬ ìƒì„±
        const modalHtml = `
            <div id="modal-${machine.machineNo}" class="modal">
                <div id="modal-content-${machine.machineNo}" class="modal-content">
                    <p class="modal-text">
                        "ì˜ˆì•½ëœ ì‹œê°„ìœ¼ë¡œë¶€í„° 10ë¶„ ì´ë‚´ì— ì´ìš©ì„ ì‹œì‘í•˜ì§€ ì•Šì„ ê²½ìš°, <br>ì˜ˆì•½ì´ ìë™ ì·¨ì†Œë©ë‹ˆë‹¤.<br>
                        ìë™ ì·¨ì†Œê°€ 3íšŒ ë°œìƒí•  ê²½ìš°, ê³„ì •ì´ ì¼ì‹œ ì •ì§€ë©ë‹ˆë‹¤."<br><br>
                    </p>
                    <span class="reserveText">ìœ„ ë‚´ìš©ì„ í™•ì¸í•˜ì‹œê³  
                        <span id="modalTimeDisplay-${machine.machineNo}" class="modal-time"></span> 
                        ì˜ˆì•½ì„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                    </span>
                    <button id="cancelButton-${machine.machineNo}" class="cancel">ì·¨ì†Œ</button>
                    <button id="confirmButton-${machine.machineNo}" class="confirm">í™•ì¸</button>
                </div>
                <div id="modal-content2-${machine.machineNo}" class="modal-content2">
                    <span class="reserveConfirm">ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</span>
                    <span class="qrText">QRì½”ë“œëŠ” ë§ˆì´í˜ì´ì§€ì—ì„œ í™•ì¸í•˜ì„¸ìš”</span>
                    <img id="qrCode-${machine.machineNo}" class="qr-code" src="" alt="QR Code">
                    <button id="confirmButton2-${machine.machineNo}" class="confirm2">í™•ì¸</button>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
        return machineDiv;
    }

    // ìƒˆë¡œ ì¶”ê°€ëœ ê¸°ê¸°ë“¤ì— ëŒ€í•œ ì´ˆê¸°í™” í•¨ìˆ˜
    function initializeNewMachines() {
        // ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        document.querySelectorAll('.dropdown').forEach(dropdown => {
            const machineNo = dropdown.id.split('-').pop();
            const type = dropdown.id.startsWith('wash') ? 'wash' : 'dry';
            
            if (!dropdown.hasEventListener) {
                dropdown.hasEventListener = true;
                dropdown.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    const price = selectedOption.getAttribute('data-price');
                    document.getElementById(`${type}-selected-option-${machineNo}`).textContent = `${price}ì›`;
                });
            }
        });

        // ì˜ˆì•½ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        document.querySelectorAll('.reservebtn').forEach(button => {
            const machineNo = button.id.split('-').pop();
            
            if (!button.hasEventListener) {
                button.hasEventListener = true;
                button.addEventListener('click', () => {
                    showReservationModal(machineNo);  // showReservationModal í•¨ìˆ˜ í˜¸ì¶œ
                });
            }
        });

        // ëª¨ë‹¬ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ë¶€ë¶„ ìˆ˜ì •
        document.querySelectorAll('.modal').forEach(modal => {
            const machineNo = modal.id.split('-').pop();
            
            const cancelButton = document.getElementById(`cancelButton-${machineNo}`);
            const confirmButton = document.getElementById(`confirmButton-${machineNo}`);
            const confirmButton2 = document.getElementById(`confirmButton2-${machineNo}`);

            // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
            if (cancelButton) {
                cancelButton.replaceWith(cancelButton.cloneNode(true));
                const newCancelButton = document.getElementById(`cancelButton-${machineNo}`);
                newCancelButton.addEventListener('click', () => {
                    modal.style.display = "none";
                    document.body.classList.remove("no-scroll");
                });
            }

            if (confirmButton) {
                confirmButton.replaceWith(confirmButton.cloneNode(true));
                const newConfirmButton = document.getElementById(`confirmButton-${machineNo}`);
                newConfirmButton.addEventListener('click', () => {
                    // ì¤‘ë³µ í´ë¦­ ë°©ì§€
                    newConfirmButton.disabled = true;
                    handleReservation(machineNo).finally(() => {
                        newConfirmButton.disabled = false;
                    });
                });
            }

            if (confirmButton2) {
                confirmButton2.replaceWith(confirmButton2.cloneNode(true));
                const newConfirmButton2 = document.getElementById(`confirmButton2-${machineNo}`);
                newConfirmButton2.addEventListener('click', () => {
                    modal.style.display = "none";
                    document.body.classList.remove("no-scroll");
                });
            }
        });

        // ëª¨ë“  ê¸°ê¸°ì˜ ì´ˆê¸° ìƒíƒœ í™•ì¸
        document.querySelectorAll('[data-machine]').forEach(machine => {
            const machineNo = machine.dataset.machine;
            checkMachineStatus(machineNo);
        });
    }

    // DOMContentLoaded ì´ë²¤íŠ¸ì—ì„œ loadMachines í˜¸ì¶œ
    loadMachines();
});
</script>


</body>
</html>