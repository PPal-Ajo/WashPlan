<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ë§ˆì´í˜ì´ì§€</title>
    <link th:href="@{/css/base/nav.css}" rel="stylesheet">
    <link th:href="@{/css/mypage/mypage.css}" rel="stylesheet">
</head>
<body>
<!-- ë°°ê²½ ì´ë¯¸ì§€ -->
<img th:src="@{/images/main/mypage.png}" alt="mainpage" class="bg">

<header>
    <nav>
        <span onclick="location.href='/'">WashPlan</span>
        <span onclick="location.href='/reservation'">ì˜ˆì•½</span>
        <span onclick="location.href='/faq'">FAQ</span>
        <span style="color: #FFFF00">ë§ˆì´í˜ì´ì§€</span>
        <span onclick="location.href='/login'">ë¡œê·¸ì•„ì›ƒ</span>
    </nav>
</header>

<main>
    <button class="info" onclick="location.href='/mypage'">íšŒì›ì •ë³´</button>
    <button class="reservation" onclick="location.href='/mypage/reservations'">ì˜ˆì•½í˜„í™©</button>
    <button class="inquiry" onclick="location.href='/mypage/inquiry'">ë¬¸ì˜ë‚´ì—­</button>

    <button class="secession">íšŒì›íƒˆí‡´</button>

    <!-- ì•„ì´ë”” -->
    <p class="id">ì•„ì´ë””</p>
    <input class="idInput" th:value="${username}" readonly>

    <!-- ë¹„ë°€ë²ˆí˜¸ -->
    <p class="pwd">ë¹„ë°€ë²ˆí˜¸</p>
    <input id="passwordInput" class="pwdInput" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ëŠ” 8ìë¦¬ ì´ìƒ ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìê°€ ê° í•˜ë‚˜ì”© í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤." required>

    <button id="changePasswordButton" class="change">ë³€ê²½</button>

    <img th:src="@{/images/login/Invisible.png}" alt="Invisible" class="ivs1">

    <!-- ì´ë©”ì¼ -->
    <p class="email">ì´ë©”ì¼</p>
    <input class="emailInput" th:value="${email}" readonly>

    <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨ ë©”ì‹œì§€ -->
    <p id="changePasswordMessage" style="display: none; color: red;"></p>

    <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í™•ì¸ ëª¨ë‹¬ -->
    <div id="confirmModal" class="modal" style="display: none;">
        <div class="modal-content1">
            <p id="changeP">ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <button id="cancelButton" class="modal-btn">ì·¨ì†Œ</button>
            <button id="confirmButton" class="modal-btn">í™•ì¸</button>
        </div>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì™„ë£Œ ëª¨ë‹¬ -->
    <div id="successModal" class="modal" style="display: none;">
        <div class="modal-content1">
            <p class="doneP">ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <button id="closeButton" class="modal-btn">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- íšŒì›íƒˆí‡´ í™•ì¸ ëª¨ë‹¬ ìˆ˜ì • -->
    <div id="secessionModal" class="modal" style="display: none;">
        <div class="modal-content">
            <p class="secessionP">ì •ë§ë¡œ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <p class="secessionSubP">ì˜êµ¬ íƒˆí‡´ë¥¼ ì›í•˜ì‹œë©´ ì•„ë˜ì— "ì˜êµ¬íƒˆí‡´"ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            <input type="text" id="secessionConfirmText" class="secession-input" placeholder="ì˜êµ¬íƒˆí‡´">
            <p id="secessionErrorMsg" class="error-message" style="display: none;">ì˜¬ë°”ë¥¸ í™•ì¸ ë¬¸êµ¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            <div class="modal-buttons">
                <button id="modalCancelButton" class="modal-btn">ì·¨ì†Œ</button>
                <button id="modalConfirmButton" class="modal-btn" disabled>í™•ì¸</button>
            </div>
        </div>
    </div>

    <div id="secessionConfirm" class="modal" style="display: none;">
        <div class="modal-content2">
            <p class="doneP2">íšŒì›íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <button id="secessionConfirmButton" class="modal-btn">í™•ì¸</button>
        </div>
    </div>


</main>

<footer>
    <span>ğŸ“031-123-4567ã…£âœ‰ï¸contact@washplan.com</span>
    <span>ğŸš©ê²½ê¸° í•˜ë‚¨ì‹œ ë¯¸ì‚¬ê°•ë³€ë™ë¡œ 85 íìŠ¤í…Œì´íŠ¸ ì—ì½” 3ì¸µ</span>
    <span>â“’ 2024 PPal-Ajoã…£All rights reserved.Designed for your convenience.</span>
</footer>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ê´€ë ¨ ë³€ìˆ˜
        const changePasswordButton = document.getElementById("changePasswordButton");
        const passwordInput = document.getElementById("passwordInput");
        const changePasswordMessage = document.getElementById("changePasswordMessage");
        const confirmModal = document.getElementById("confirmModal");
        const successModal = document.getElementById("successModal");
        const confirmButton = document.getElementById("confirmButton");
        const cancelButton = document.getElementById("cancelButton");
        const closeButton = document.getElementById("closeButton");

        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        changePasswordButton.addEventListener("click", function () {
            const newPassword = passwordInput.value;

            // í´ë¼ì´ì–¸íŠ¸ ì¸¡ ìœ íš¨ì„± ê²€ì‚¬
            if (newPassword.length < 8 || !/\d/.test(newPassword) || !/[!@#$%^&*]/.test(newPassword)) {
                changePasswordMessage.style.color = "red";
                changePasswordMessage.style.display = "block";
                changePasswordMessage.innerText = "ì‚¬ìš© ë¶ˆê°€ëŠ¥í•œ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.";
                return;
            }

            // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í™•ì¸ ëª¨ë‹¬ ì—´ê¸°
            confirmModal.style.display = "flex";

            // í™•ì¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            confirmButton.addEventListener("click", function () {
                confirmModal.style.display = "none";

                // ì„œë²„ì— ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ìš”ì²­
                fetch('/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password: newPassword })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // ì„±ê³µ ëª¨ë‹¬ ì—´ê¸°
                            successModal.style.display = "flex";
                        } else {
                            alert(data.message || "ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        }
                    })
                    .catch(error => {
                        alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                    });
            });

            // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            cancelButton.addEventListener("click", function () {
                confirmModal.style.display = "none";
            });
        });

        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì™„ë£Œ ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        closeButton.addEventListener("click", function () {
            successModal.style.display = "none";

            // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì¹¸ ì´ˆê¸°í™”
            passwordInput.value = "";
            passwordInput.placeholder = "ë¹„ë°€ë²ˆí˜¸ëŠ” 8ìë¦¬ ì´ìƒ ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìê°€ ê° í•˜ë‚˜ì”© í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.";

            // ì—ëŸ¬ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
            changePasswordMessage.style.display = "none";
        });

        // íšŒì›íƒˆí‡´ ê´€ë ¨ ë³€ìˆ˜
        const secessionButton = document.querySelector(".secession");
        const secessionModal = document.getElementById("secessionModal");
        const secessionConfirmModal = document.getElementById("secessionConfirm");
        const modalCancelButton = document.getElementById("modalCancelButton");
        const modalConfirmButton = document.getElementById("modalConfirmButton");
        const secessionConfirmButton = document.getElementById("secessionConfirmButton");
        const secessionInput = document.getElementById('secessionConfirmText');

        // íšŒì›íƒˆí‡´ ë²„íŠ¼ í´ë¦­ ì‹œ íƒˆí‡´ í™•ì¸ ëª¨ë‹¬ ì—´ê¸°
        secessionButton.addEventListener("click", function () {
            secessionModal.style.display = "flex";
        });

        // ì…ë ¥ê°’ í™•ì¸
        secessionInput.addEventListener('input', function() {
            const errorMsg = document.getElementById('secessionErrorMsg');

            if (this.value === 'ì˜êµ¬íƒˆí‡´') {
                modalConfirmButton.disabled = false;
                errorMsg.style.display = 'none'; // ì—ëŸ¬ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
            } else {
                modalConfirmButton.disabled = true;
                errorMsg.style.display = 'block'; // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
            }
        });

        // ëª¨ë‹¬ ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById("modalCancelButton").onclick = function() {
            document.getElementById("secessionModal").style.display = "none";
            document.getElementById("secessionConfirmText").value = '';
            document.getElementById("modalConfirmButton").disabled = true;
            document.getElementById("secessionErrorMsg").style.display = 'none';
        };

        // íƒˆí‡´ í™•ì¸ ëª¨ë‹¬ í™•ì¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        modalConfirmButton.addEventListener("click", function () {
            const errorMsg = document.getElementById('secessionErrorMsg');

            if (secessionInput.value !== 'ì˜êµ¬íƒˆí‡´') {
                errorMsg.style.display = 'block'; // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                return;
            }

            // ì…ë ¥ê°’ì´ ë§ìœ¼ë©´ ì—ëŸ¬ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
            errorMsg.style.display = 'none';

            fetch('/delete-account', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    secessionModal.style.display = "none";
                    if (response.ok) {
                        // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
                        fetch('/logout', { method: 'POST' })
                            .then(() => {
                                secessionConfirmModal.style.display = "flex";
                            })
                            .catch(error => {
                                console.error("ë¡œê·¸ì•„ì›ƒ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", error);
                                alert("ë¡œê·¸ì•„ì›ƒ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                            });
                    } else {
                        alert("íšŒì› íƒˆí‡´ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                    }
                })
                .catch(error => {
                    secessionModal.style.display = "none";
                    alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                    console.error(error);
                });
        });

        // íƒˆí‡´ ì™„ë£Œ ëª¨ë‹¬ í™•ì¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        secessionConfirmButton.addEventListener("click", function () {
            secessionConfirmModal.style.display = "none"; // íƒˆí‡´ ì™„ë£Œ ëª¨ë‹¬ ë‹«ê¸°
            window.location.href = '/'; // ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
        });




        // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œì™€ í† ê¸€ ë²„íŠ¼
        const checkPasswordInput = document.getElementById('checkPasswordInput');
        const passwordToggle = document.querySelector('.password-toggle');
        let isPasswordVisible = false;

        // ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€
        passwordToggle.addEventListener('click', () => {
            isPasswordVisible = !isPasswordVisible;
            checkPasswordInput.type = isPasswordVisible ? 'text' : 'password';
        });

        // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
        document.getElementById("checkCancelButton").onclick = function() {
            window.location.href = '/';
        };
    });

    // ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ/ìˆ¨ê¹€ ê´€ë ¨ ì½”ë“œ
    const ivs1 = document.querySelector('.ivs1');
    const passwordInput = document.getElementById('passwordInput');
    let isPasswordVisible = false;

    ivs1.addEventListener('click', () => {
        isPasswordVisible = !isPasswordVisible;
        passwordInput.type = isPasswordVisible ? 'text' : 'password';
    });
</script>
</body>
</html>