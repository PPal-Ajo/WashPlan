<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>비밀번호 재설정</title>
  <link th:href="@{/css/base/nav.css}" rel="stylesheet">
  <link th:href="@{/css/auth/reset.css}" rel="stylesheet">
</head>
<body>
<!-- 배경 이미지 -->
<img th:src="@{/images/signup/Signup.png}" alt="mainpage" class="bg">

<header>
  <nav>
    <span>WashPlan</span>
    <span>예약</span>
    <span>FAQ</span>
    <span style="color: #FFFF00">회원가입</span>
    <span>로그인</span>
  </nav>
</header>

<main>
  <span class="resetLogo">비밀번호 재설정</span>
  <span class="resetDetail">비밀번호를 재설정해주세요</span>

  <div class="pwdBox">
    <label for="pwdInput">비밀번호 : </label>
    <input type="password" id="pwdInput" placeholder="새 비밀번호">
  </div>

  <div class="pwdRepeatBox">
    <label for="pwdRepeatInput">비밀번호 재확인 : </label>
    <input type="password" id="pwdRepeatInput" placeholder="비밀번호 재확인">
  </div>

  <button class="completeBtn" id="completeBtn">완료</button>

  <p id="errorMsg" style="display: none; color: red; margin-top: 10px; font-size: 14px;">
    에러 메시지가 표시될 공간입니다.
  </p>
</main>

<script>
  document.getElementById("completeBtn").addEventListener("click", () => {
    const password = document.getElementById("pwdInput").value;
    const confirmPassword = document.getElementById("pwdRepeatInput").value;
    const errorMsg = document.getElementById("errorMsg");

    // 초기화: 메시지를 숨김
    errorMsg.style.display = "none";
    errorMsg.textContent = "";

    // 비밀번호 유효성 검사
    const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$/;

    if (!password || !confirmPassword) {
      errorMsg.textContent = "비밀번호를 입력해주세요.";
      errorMsg.style.display = "block";
      return;
    }

    if (!passwordRegex.test(password)) {
      errorMsg.textContent = "비밀번호는 8자 이상이어야 하며, 영문, 숫자, 특수문자를 포함해야 합니다.";
      errorMsg.style.display = "block";
      return;
    }

    if (password !== confirmPassword) {
      errorMsg.textContent = "비밀번호가 일치하지 않습니다.";
      errorMsg.style.display = "block";
      return;
    }

    // 서버에 요청 보내기
    fetch('/auth/reset-password', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ newPassword: password })
    })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                alert("비밀번호가 성공적으로 변경되었습니다.");
                window.location.href = "/login"; // 로그인 페이지로 이동
              } else {
                errorMsg.textContent = data.message || "비밀번호 재설정에 실패했습니다.";
                errorMsg.style.display = "block";
              }
            })
            .catch(error => {
              console.error('Error:', error);
              errorMsg.textContent = "서버 오류가 발생했습니다.";
              errorMsg.style.display = "block";
            });
  });
</script>
</body>
</html>